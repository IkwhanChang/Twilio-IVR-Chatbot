{"ast":null,"code":"import { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nvar _jsxFileName = \"/Users/matthewchang/workspace/github/SEM2020/store-owner-console/src/components/SidePanel/Channels.js\";\nimport React from \"react\";\nimport firebase from \"../../firebase\";\nimport { connect } from \"react-redux\";\nimport { setCurrentChannel, setPrivateChannel } from \"../../actions\"; // prettier-ignore\n\nimport { Menu, Icon, Modal, Form, Input, Button, Label } from \"semantic-ui-react\";\n\nclass Channels extends React.Component {\n  constructor(...args) {\n    super(...args);\n    this.state = {\n      activeChannel: \"\",\n      user: this.props.currentUser,\n      channel: null,\n      channels: [],\n      channelName: \"\",\n      channelDetails: \"\",\n      channelsRef: firebase.database().ref(\"customers\").child(this.props.currentUser.uid),\n      messagesRef: firebase.database().ref(\"messages\"),\n      typingRef: firebase.database().ref(\"typing\"),\n      notifications: [],\n      modal: false,\n      firstLoad: true\n    };\n\n    this.addListeners = () => {\n      let loadedChannels = [];\n      this.state.channelsRef.on(\"child_added\", snap => {\n        loadedChannels.push({ ...snap.val(),\n          id: snap.key\n        });\n        this.setState({\n          channels: loadedChannels\n        }, () => this.setFirstChannel());\n        this.addNotificationListener(snap.key);\n      });\n    };\n\n    this.addNotificationListener = channelId => {\n      this.state.messagesRef.child(channelId).on(\"value\", snap => {\n        if (this.state.channel) {\n          this.handleNotifications(channelId, this.state.channel.id, this.state.notifications, snap);\n        }\n      });\n    };\n\n    this.handleNotifications = (channelId, currentChannelId, notifications, snap) => {\n      let lastTotal = 0;\n      let index = notifications.findIndex(notification => notification.id === channelId);\n\n      if (index !== -1) {\n        if (channelId !== currentChannelId) {\n          lastTotal = notifications[index].total;\n\n          if (snap.numChildren() - lastTotal > 0) {\n            notifications[index].count = snap.numChildren() - lastTotal;\n          }\n        }\n\n        notifications[index].lastKnownTotal = snap.numChildren();\n      } else {\n        notifications.push({\n          id: channelId,\n          total: snap.numChildren(),\n          lastKnownTotal: snap.numChildren(),\n          count: 0\n        });\n      }\n\n      this.setState({\n        notifications\n      });\n    };\n\n    this.removeListeners = () => {\n      this.state.channelsRef.off();\n      this.state.channels.forEach(channel => {\n        this.state.messagesRef.child(channel.id).off();\n      });\n    };\n\n    this.setFirstChannel = () => {\n      const firstChannel = this.state.channels[0];\n\n      if (this.state.firstLoad && this.state.channels.length > 0) {\n        this.props.setCurrentChannel(firstChannel);\n        this.setActiveChannel(firstChannel);\n        this.setState({\n          channel: firstChannel\n        });\n      }\n\n      this.setState({\n        firstLoad: false\n      });\n    };\n\n    this.addChannel = () => {\n      const {\n        channelsRef,\n        channelName,\n        channelDetails,\n        user\n      } = this.state;\n      const key = channelsRef.push().key;\n      const newChannel = {\n        id: key,\n        name: channelName,\n        details: channelDetails,\n        createdBy: {\n          name: user.displayName,\n          avatar: user.photoURL\n        }\n      };\n      channelsRef.child(key).update(newChannel).then(() => {\n        this.setState({\n          channelName: \"\",\n          channelDetails: \"\"\n        });\n        this.closeModal();\n        console.log(\"channel added\");\n      }).catch(err => {\n        console.error(err);\n      });\n    };\n\n    this.handleSubmit = event => {\n      event.preventDefault();\n\n      if (this.isFormValid(this.state)) {\n        this.addChannel();\n      }\n    };\n\n    this.handleChange = event => {\n      this.setState({\n        [event.target.name]: event.target.value\n      });\n    };\n\n    this.changeChannel = channel => {\n      this.setActiveChannel(channel);\n      this.state.typingRef.child(this.state.channel.id).child(this.state.user.uid).remove();\n      this.clearNotifications();\n      this.props.setCurrentChannel(channel);\n      this.props.setPrivateChannel(false);\n      this.setState({\n        channel\n      });\n    };\n\n    this.clearNotifications = () => {\n      let index = this.state.notifications.findIndex(notification => notification.id === this.state.channel.id);\n\n      if (index !== -1) {\n        let updatedNotifications = [...this.state.notifications];\n        updatedNotifications[index].total = this.state.notifications[index].lastKnownTotal;\n        updatedNotifications[index].count = 0;\n        this.setState({\n          notifications: updatedNotifications\n        });\n      }\n    };\n\n    this.setActiveChannel = channel => {\n      this.setState({\n        activeChannel: channel.id\n      });\n    };\n\n    this.getNotificationCount = channel => {\n      let count = 0;\n      this.state.notifications.forEach(notification => {\n        if (notification.id === channel.id) {\n          count = notification.count;\n        }\n      });\n      if (count > 0) return count;\n    };\n\n    this.displayChannels = channels => channels.length > 0 && channels.map(channel => /*#__PURE__*/_jsxDEV(Menu.Item, {\n      onClick: () => this.changeChannel(channel),\n      name: channel.name,\n      style: {\n        opacity: 0.7\n      },\n      active: channel.id === this.state.activeChannel,\n      children: [this.getNotificationCount(channel) && /*#__PURE__*/_jsxDEV(Label, {\n        color: \"red\",\n        children: this.getNotificationCount(channel)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 192,\n        columnNumber: 11\n      }, this), channel.name]\n    }, channel.id, true, {\n      fileName: _jsxFileName,\n      lineNumber: 184,\n      columnNumber: 7\n    }, this));\n\n    this.isFormValid = ({\n      channelName,\n      channelDetails\n    }) => channelName && channelDetails;\n\n    this.openModal = () => this.setState({\n      modal: true\n    });\n\n    this.closeModal = () => this.setState({\n      modal: false\n    });\n  }\n\n  componentDidMount() {\n    this.addListeners();\n  }\n\n  componentWillUnmount() {\n    this.removeListeners();\n  }\n\n  render() {\n    const {\n      channels,\n      modal\n    } = this.state;\n    return /*#__PURE__*/_jsxDEV(React.Fragment, {\n      children: [/*#__PURE__*/_jsxDEV(Menu.Menu, {\n        className: \"menu\",\n        children: [/*#__PURE__*/_jsxDEV(Menu.Item, {\n          children: [/*#__PURE__*/_jsxDEV(\"span\", {\n            children: [/*#__PURE__*/_jsxDEV(Icon, {\n              name: \"address book\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 213,\n              columnNumber: 15\n            }, this), \" CUSTOMERS\"]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 212,\n            columnNumber: 13\n          }, this), \" \", \"(\", channels.length, \")\"]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 211,\n          columnNumber: 11\n        }, this), this.displayChannels(channels)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 210,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(Modal, {\n        basic: true,\n        open: modal,\n        onClose: this.closeModal,\n        children: [/*#__PURE__*/_jsxDEV(Modal.Header, {\n          children: \"Add a Channel\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 223,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(Modal.Content, {\n          children: /*#__PURE__*/_jsxDEV(Form, {\n            onSubmit: this.handleSubmit,\n            children: [/*#__PURE__*/_jsxDEV(Form.Field, {\n              children: /*#__PURE__*/_jsxDEV(Input, {\n                fluid: true,\n                label: \"Name of Channel\",\n                name: \"channelName\",\n                onChange: this.handleChange\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 227,\n                columnNumber: 17\n              }, this)\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 226,\n              columnNumber: 15\n            }, this), /*#__PURE__*/_jsxDEV(Form.Field, {\n              children: /*#__PURE__*/_jsxDEV(Input, {\n                fluid: true,\n                label: \"About the Channel\",\n                name: \"channelDetails\",\n                onChange: this.handleChange\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 236,\n                columnNumber: 17\n              }, this)\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 235,\n              columnNumber: 15\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 225,\n            columnNumber: 13\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 224,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(Modal.Actions, {\n          children: [/*#__PURE__*/_jsxDEV(Button, {\n            color: \"green\",\n            inverted: true,\n            onClick: this.handleSubmit,\n            children: [/*#__PURE__*/_jsxDEV(Icon, {\n              name: \"checkmark\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 248,\n              columnNumber: 15\n            }, this), \" Add\"]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 247,\n            columnNumber: 13\n          }, this), /*#__PURE__*/_jsxDEV(Button, {\n            color: \"red\",\n            inverted: true,\n            onClick: this.closeModal,\n            children: [/*#__PURE__*/_jsxDEV(Icon, {\n              name: \"remove\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 251,\n              columnNumber: 15\n            }, this), \" Cancel\"]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 250,\n            columnNumber: 13\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 246,\n          columnNumber: 11\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 222,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 209,\n      columnNumber: 7\n    }, this);\n  }\n\n}\n\nexport default connect(null, {\n  setCurrentChannel,\n  setPrivateChannel\n})(Channels);","map":{"version":3,"sources":["/Users/matthewchang/workspace/github/SEM2020/store-owner-console/src/components/SidePanel/Channels.js"],"names":["React","firebase","connect","setCurrentChannel","setPrivateChannel","Menu","Icon","Modal","Form","Input","Button","Label","Channels","Component","state","activeChannel","user","props","currentUser","channel","channels","channelName","channelDetails","channelsRef","database","ref","child","uid","messagesRef","typingRef","notifications","modal","firstLoad","addListeners","loadedChannels","on","snap","push","val","id","key","setState","setFirstChannel","addNotificationListener","channelId","handleNotifications","currentChannelId","lastTotal","index","findIndex","notification","total","numChildren","count","lastKnownTotal","removeListeners","off","forEach","firstChannel","length","setActiveChannel","addChannel","newChannel","name","details","createdBy","displayName","avatar","photoURL","update","then","closeModal","console","log","catch","err","error","handleSubmit","event","preventDefault","isFormValid","handleChange","target","value","changeChannel","remove","clearNotifications","updatedNotifications","getNotificationCount","displayChannels","map","opacity","openModal","componentDidMount","componentWillUnmount","render"],"mappings":"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","sourcesContent":["import React from \"react\";\nimport firebase from \"../../firebase\";\nimport { connect } from \"react-redux\";\nimport { setCurrentChannel, setPrivateChannel } from \"../../actions\";\n// prettier-ignore\nimport { Menu, Icon, Modal, Form, Input, Button, Label } from \"semantic-ui-react\";\n\nclass Channels extends React.Component {\n  state = {\n    activeChannel: \"\",\n    user: this.props.currentUser,\n    channel: null,\n    channels: [],\n    channelName: \"\",\n    channelDetails: \"\",\n    channelsRef: firebase.database().ref(\"customers\").child(this.props.currentUser.uid),\n    messagesRef: firebase.database().ref(\"messages\"),\n    typingRef: firebase.database().ref(\"typing\"),\n    notifications: [],\n    modal: false,\n    firstLoad: true\n  };\n\n  componentDidMount() {\n    this.addListeners();\n  }\n\n  componentWillUnmount() {\n    this.removeListeners();\n  }\n\n  addListeners = () => {\n    let loadedChannels = [];\n    this.state.channelsRef.on(\"child_added\", snap => {\n      loadedChannels.push({...snap.val(), id: snap.key});\n      this.setState({ channels: loadedChannels }, () => this.setFirstChannel());\n      this.addNotificationListener(snap.key);\n    });\n  };\n\n  addNotificationListener = channelId => {\n    this.state.messagesRef.child(channelId).on(\"value\", snap => {\n      if (this.state.channel) {\n        this.handleNotifications(\n          channelId,\n          this.state.channel.id,\n          this.state.notifications,\n          snap\n        );\n      }\n    });\n  };\n\n  handleNotifications = (channelId, currentChannelId, notifications, snap) => {\n    let lastTotal = 0;\n\n    let index = notifications.findIndex(\n      notification => notification.id === channelId\n    );\n\n    if (index !== -1) {\n      if (channelId !== currentChannelId) {\n        lastTotal = notifications[index].total;\n\n        if (snap.numChildren() - lastTotal > 0) {\n          notifications[index].count = snap.numChildren() - lastTotal;\n        }\n      }\n      notifications[index].lastKnownTotal = snap.numChildren();\n    } else {\n      notifications.push({\n        id: channelId,\n        total: snap.numChildren(),\n        lastKnownTotal: snap.numChildren(),\n        count: 0\n      });\n    }\n\n    this.setState({ notifications });\n  };\n\n  removeListeners = () => {\n    this.state.channelsRef.off();\n    this.state.channels.forEach(channel => {\n      this.state.messagesRef.child(channel.id).off();\n    });\n  };\n\n  setFirstChannel = () => {\n    const firstChannel = this.state.channels[0];\n    if (this.state.firstLoad && this.state.channels.length > 0) {\n      this.props.setCurrentChannel(firstChannel);\n      this.setActiveChannel(firstChannel);\n      this.setState({ channel: firstChannel });\n    }\n    this.setState({ firstLoad: false });\n  };\n\n  addChannel = () => {\n    const { channelsRef, channelName, channelDetails, user } = this.state;\n\n    const key = channelsRef.push().key;\n\n    const newChannel = {\n      id: key,\n      name: channelName,\n      details: channelDetails,\n      createdBy: {\n        name: user.displayName,\n        avatar: user.photoURL\n      }\n    };\n\n    channelsRef\n      .child(key)\n      .update(newChannel)\n      .then(() => {\n        this.setState({ channelName: \"\", channelDetails: \"\" });\n        this.closeModal();\n        console.log(\"channel added\");\n      })\n      .catch(err => {\n        console.error(err);\n      });\n  };\n\n  handleSubmit = event => {\n    event.preventDefault();\n    if (this.isFormValid(this.state)) {\n      this.addChannel();\n    }\n  };\n\n  handleChange = event => {\n    this.setState({ [event.target.name]: event.target.value });\n  };\n\n  changeChannel = channel => {\n    this.setActiveChannel(channel);\n    this.state.typingRef\n      .child(this.state.channel.id)\n      .child(this.state.user.uid)\n      .remove();\n    this.clearNotifications();\n    this.props.setCurrentChannel(channel);\n    this.props.setPrivateChannel(false);\n    this.setState({ channel });\n  };\n\n  clearNotifications = () => {\n    let index = this.state.notifications.findIndex(\n      notification => notification.id === this.state.channel.id\n    );\n\n    if (index !== -1) {\n      let updatedNotifications = [...this.state.notifications];\n      updatedNotifications[index].total = this.state.notifications[\n        index\n      ].lastKnownTotal;\n      updatedNotifications[index].count = 0;\n      this.setState({ notifications: updatedNotifications });\n    }\n  };\n\n  setActiveChannel = channel => {\n    this.setState({ activeChannel: channel.id });\n  };\n\n  getNotificationCount = channel => {\n    let count = 0;\n\n    this.state.notifications.forEach(notification => {\n      if (notification.id === channel.id) {\n        count = notification.count;\n      }\n    });\n\n    if (count > 0) return count;\n  };\n\n  displayChannels = channels =>\n    channels.length > 0 &&\n    channels.map(channel => (\n      <Menu.Item\n        key={channel.id}\n        onClick={() => this.changeChannel(channel)}\n        name={channel.name}\n        style={{ opacity: 0.7 }}\n        active={channel.id === this.state.activeChannel}\n      >\n        {this.getNotificationCount(channel) && (\n          <Label color=\"red\">{this.getNotificationCount(channel)}</Label>\n        )}\n         {channel.name}\n      </Menu.Item>\n    ));\n\n  isFormValid = ({ channelName, channelDetails }) =>\n    channelName && channelDetails;\n\n  openModal = () => this.setState({ modal: true });\n\n  closeModal = () => this.setState({ modal: false });\n\n  render() {\n    const { channels, modal } = this.state;\n\n    return (\n      <React.Fragment>\n        <Menu.Menu className=\"menu\">\n          <Menu.Item>\n            <span>\n              <Icon name=\"address book\" /> CUSTOMERS\n            </span>{\" \"}\n            ({channels.length}) \n            {/* <Icon name=\"add\" onClick={this.openModal} /> */}\n          </Menu.Item>\n          {this.displayChannels(channels)}\n        </Menu.Menu>\n\n        {/* Add Channel Modal */}\n        <Modal basic open={modal} onClose={this.closeModal}>\n          <Modal.Header>Add a Channel</Modal.Header>\n          <Modal.Content>\n            <Form onSubmit={this.handleSubmit}>\n              <Form.Field>\n                <Input\n                  fluid\n                  label=\"Name of Channel\"\n                  name=\"channelName\"\n                  onChange={this.handleChange}\n                />\n              </Form.Field>\n\n              <Form.Field>\n                <Input\n                  fluid\n                  label=\"About the Channel\"\n                  name=\"channelDetails\"\n                  onChange={this.handleChange}\n                />\n              </Form.Field>\n            </Form>\n          </Modal.Content>\n\n          <Modal.Actions>\n            <Button color=\"green\" inverted onClick={this.handleSubmit}>\n              <Icon name=\"checkmark\" /> Add\n            </Button>\n            <Button color=\"red\" inverted onClick={this.closeModal}>\n              <Icon name=\"remove\" /> Cancel\n            </Button>\n          </Modal.Actions>\n        </Modal>\n      </React.Fragment>\n    );\n  }\n}\n\nexport default connect(\n  null,\n  { setCurrentChannel, setPrivateChannel }\n)(Channels);\n"]},"metadata":{},"sourceType":"module"}