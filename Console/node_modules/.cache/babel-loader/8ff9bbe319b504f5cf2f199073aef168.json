{"ast":null,"code":"import _defineProperty from\"/Users/matthewchang/workspace/github/SEM2020/store-owner-console/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/defineProperty\";import _classCallCheck from\"/Users/matthewchang/workspace/github/SEM2020/store-owner-console/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"/Users/matthewchang/workspace/github/SEM2020/store-owner-console/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";import _inherits from\"/Users/matthewchang/workspace/github/SEM2020/store-owner-console/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/inherits\";import _createSuper from\"/Users/matthewchang/workspace/github/SEM2020/store-owner-console/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createSuper\";import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import React from\"react\";import uuidv4 from\"uuid/v4\";import firebase from\"../../firebase\";import{Segment,Button,Input}from\"semantic-ui-react\";import{Picker,emojiIndex}from\"emoji-mart\";import\"emoji-mart/css/emoji-mart.css\";import FileModal from\"./FileModal\";import ProgressBar from\"./ProgressBar\";var MessageForm=/*#__PURE__*/function(_React$Component){_inherits(MessageForm,_React$Component);var _super=_createSuper(MessageForm);function MessageForm(){var _this;_classCallCheck(this,MessageForm);for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}_this=_super.call.apply(_super,[this].concat(args));_this.state={storageRef:firebase.storage().ref(),typingRef:firebase.database().ref(\"typing\"),uploadTask:null,uploadState:\"\",percentUploaded:0,message:\"\",channel:_this.props.currentChannel,user:_this.props.currentUser,loading:false,errors:[],modal:false,emojiPicker:false};_this.openModal=function(){return _this.setState({modal:true});};_this.closeModal=function(){return _this.setState({modal:false});};_this.handleChange=function(event){_this.setState(_defineProperty({},event.target.name,event.target.value));};_this.handleKeyDown=function(event){if(event.ctrlKey&&event.keyCode===13){_this.sendMessage();}var _this$state=_this.state,message=_this$state.message,typingRef=_this$state.typingRef,channel=_this$state.channel,user=_this$state.user;if(message){typingRef.child(channel.id).child(user.uid).set(user.displayName);}else{typingRef.child(channel.id).child(user.uid).remove();}};_this.handleTogglePicker=function(){_this.setState({emojiPicker:!_this.state.emojiPicker});};_this.handleAddEmoji=function(emoji){var oldMessage=_this.state.message;var newMessage=_this.colonToUnicode(\" \".concat(oldMessage,\" \").concat(emoji.colons,\" \"));_this.setState({message:newMessage,emojiPicker:false});setTimeout(function(){return _this.messageInputRef.focus();},0);};_this.colonToUnicode=function(message){return message.replace(/:[A-Za-z0-9_+-]+:/g,function(x){x=x.replace(/:/g,\"\");var emoji=emojiIndex.emojis[x];if(typeof emoji!==\"undefined\"){var unicode=emoji.native;if(typeof unicode!==\"undefined\"){return unicode;}}x=\":\"+x+\":\";return x;});};_this.createMessage=function(){var fileUrl=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;var message={timestamp:firebase.database.ServerValue.TIMESTAMP,id:_this.state.user.uid,name:_this.state.user.displayName,avatar:_this.state.user.photoURL,senderName:_this.state.user.displayName};if(fileUrl!==null){message[\"image\"]=fileUrl;}else{message[\"message\"]=_this.state.message;}return message;};_this.sendMessage=function(){var getMessagesRef=_this.props.getMessagesRef;var _this$state2=_this.state,message=_this$state2.message,channel=_this$state2.channel,user=_this$state2.user,typingRef=_this$state2.typingRef;if(message){_this.setState({loading:true});getMessagesRef().child(user.uid).child(channel.id).push().set(_this.createMessage()).then(function(){_this.setState({loading:false,message:\"\",errors:[]});typingRef.child(channel.id).child(user.uid).remove();}).catch(function(err){console.error(err);_this.setState({loading:false,errors:_this.state.errors.concat(err)});});}else{_this.setState({errors:_this.state.errors.concat({message:\"Add a message\"})});}};_this.getPath=function(){if(_this.props.isPrivateChannel){return\"chat/private/\".concat(_this.state.channel.id);}else{return\"chat/public\";}};_this.uploadFile=function(file,metadata){var pathToUpload=_this.state.channel.id;var ref=_this.props.getMessagesRef();var filePath=\"\".concat(_this.getPath(),\"/\").concat(uuidv4(),\".jpg\");_this.setState({uploadState:\"uploading\",uploadTask:_this.state.storageRef.child(filePath).put(file,metadata)},function(){_this.state.uploadTask.on(\"state_changed\",function(snap){var percentUploaded=Math.round(snap.bytesTransferred/snap.totalBytes*100);_this.setState({percentUploaded:percentUploaded});},function(err){console.error(err);_this.setState({errors:_this.state.errors.concat(err),uploadState:\"error\",uploadTask:null});},function(){_this.state.uploadTask.snapshot.ref.getDownloadURL().then(function(downloadUrl){_this.sendFileMessage(downloadUrl,ref,pathToUpload);}).catch(function(err){console.error(err);_this.setState({errors:_this.state.errors.concat(err),uploadState:\"error\",uploadTask:null});});});});};_this.sendFileMessage=function(fileUrl,ref,pathToUpload){ref.child(pathToUpload).push().set(_this.createMessage(fileUrl)).then(function(){_this.setState({uploadState:\"done\"});}).catch(function(err){console.error(err);_this.setState({errors:_this.state.errors.concat(err)});});};return _this;}_createClass(MessageForm,[{key:\"componentWillUnmount\",value:function componentWillUnmount(){if(this.state.uploadTask!==null){this.state.uploadTask.cancel();this.setState({uploadTask:null});}}},{key:\"render\",value:function render(){var _this2=this;// prettier-ignore\nvar _this$state3=this.state,errors=_this$state3.errors,message=_this$state3.message,loading=_this$state3.loading,modal=_this$state3.modal,uploadState=_this$state3.uploadState,percentUploaded=_this$state3.percentUploaded,emojiPicker=_this$state3.emojiPicker;return/*#__PURE__*/_jsxs(Segment,{className:\"message__form\",children:[emojiPicker&&/*#__PURE__*/_jsx(Picker,{set:\"apple\",onSelect:this.handleAddEmoji,className:\"emojipicker\",title:\"Pick your emoji\",emoji:\"point_up\"}),/*#__PURE__*/_jsx(Input,{fluid:true,name:\"message\",onChange:this.handleChange,onKeyDown:this.handleKeyDown,value:message,ref:function ref(node){return _this2.messageInputRef=node;},style:{marginBottom:\"0.7em\"},label:/*#__PURE__*/_jsx(Button,{icon:emojiPicker?\"close\":\"add\",content:emojiPicker?\"Close\":null,onClick:this.handleTogglePicker}),labelPosition:\"left\",className:errors.some(function(error){return error.message.includes(\"message\");})?\"error\":\"\",placeholder:\"Write your message\"}),/*#__PURE__*/_jsx(Button.Group,{icon:true,widths:\"2\",children:/*#__PURE__*/_jsx(Button,{onClick:this.sendMessage,disabled:loading,color:\"orange\",content:\"Add Reply\",labelPosition:\"left\",icon:\"edit\"})}),/*#__PURE__*/_jsx(FileModal,{modal:modal,closeModal:this.closeModal,uploadFile:this.uploadFile}),/*#__PURE__*/_jsx(ProgressBar,{uploadState:uploadState,percentUploaded:percentUploaded})]});}}]);return MessageForm;}(React.Component);export default MessageForm;","map":{"version":3,"sources":["/Users/matthewchang/workspace/github/SEM2020/store-owner-console/src/components/Messages/MessageForm.js"],"names":["React","uuidv4","firebase","Segment","Button","Input","Picker","emojiIndex","FileModal","ProgressBar","MessageForm","state","storageRef","storage","ref","typingRef","database","uploadTask","uploadState","percentUploaded","message","channel","props","currentChannel","user","currentUser","loading","errors","modal","emojiPicker","openModal","setState","closeModal","handleChange","event","target","name","value","handleKeyDown","ctrlKey","keyCode","sendMessage","child","id","uid","set","displayName","remove","handleTogglePicker","handleAddEmoji","emoji","oldMessage","newMessage","colonToUnicode","colons","setTimeout","messageInputRef","focus","replace","x","emojis","unicode","native","createMessage","fileUrl","timestamp","ServerValue","TIMESTAMP","avatar","photoURL","senderName","getMessagesRef","push","then","catch","err","console","error","concat","getPath","isPrivateChannel","uploadFile","file","metadata","pathToUpload","filePath","put","on","snap","Math","round","bytesTransferred","totalBytes","snapshot","getDownloadURL","downloadUrl","sendFileMessage","cancel","node","marginBottom","some","includes","Component"],"mappings":"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","sourcesContent":["import React from \"react\";\nimport uuidv4 from \"uuid/v4\";\nimport firebase from \"../../firebase\";\nimport { Segment, Button, Input } from \"semantic-ui-react\";\nimport { Picker, emojiIndex } from \"emoji-mart\";\nimport \"emoji-mart/css/emoji-mart.css\";\n\nimport FileModal from \"./FileModal\";\nimport ProgressBar from \"./ProgressBar\";\n\nclass MessageForm extends React.Component {\n  state = {\n    storageRef: firebase.storage().ref(),\n    typingRef: firebase.database().ref(\"typing\"),\n    uploadTask: null,\n    uploadState: \"\",\n    percentUploaded: 0,\n    message: \"\",\n    channel: this.props.currentChannel,\n    user: this.props.currentUser,\n    loading: false,\n    errors: [],\n    modal: false,\n    emojiPicker: false\n  };\n\n  componentWillUnmount() {\n    if (this.state.uploadTask !== null) {\n      this.state.uploadTask.cancel();\n      this.setState({ uploadTask: null });\n    }\n  }\n\n  openModal = () => this.setState({ modal: true });\n\n  closeModal = () => this.setState({ modal: false });\n\n  handleChange = event => {\n    this.setState({ [event.target.name]: event.target.value });\n  };\n\n  handleKeyDown = event => {\n    if (event.ctrlKey && event.keyCode === 13) {\n      this.sendMessage();\n    }\n\n    const { message, typingRef, channel, user } = this.state;\n\n    if (message) {\n      typingRef\n        .child(channel.id)\n        .child(user.uid)\n        .set(user.displayName);\n    } else {\n      typingRef\n        .child(channel.id)\n        .child(user.uid)\n        .remove();\n    }\n  };\n\n  handleTogglePicker = () => {\n    this.setState({ emojiPicker: !this.state.emojiPicker });\n  };\n\n  handleAddEmoji = emoji => {\n    const oldMessage = this.state.message;\n    const newMessage = this.colonToUnicode(` ${oldMessage} ${emoji.colons} `);\n    this.setState({ message: newMessage, emojiPicker: false });\n    setTimeout(() => this.messageInputRef.focus(), 0);\n  };\n\n  colonToUnicode = message => {\n    return message.replace(/:[A-Za-z0-9_+-]+:/g, x => {\n      x = x.replace(/:/g, \"\");\n      let emoji = emojiIndex.emojis[x];\n      if (typeof emoji !== \"undefined\") {\n        let unicode = emoji.native;\n        if (typeof unicode !== \"undefined\") {\n          return unicode;\n        }\n      }\n      x = \":\" + x + \":\";\n      return x;\n    });\n  };\n\n  createMessage = (fileUrl = null) => {\n    const message = {\n      timestamp: firebase.database.ServerValue.TIMESTAMP,\n      id: this.state.user.uid,\n        name: this.state.user.displayName,\n        avatar: this.state.user.photoURL,\n        senderName: this.state.user.displayName\n    };\n    if (fileUrl !== null) {\n      message[\"image\"] = fileUrl;\n    } else {\n      message[\"message\"] = this.state.message;\n    }\n    return message;\n  };\n\n  sendMessage = () => {\n    const { getMessagesRef } = this.props;\n    const { message, channel, user, typingRef } = this.state;\n\n    if (message) {\n      this.setState({ loading: true });\n      getMessagesRef()\n        .child(user.uid)\n        .child(channel.id)\n        .push()\n        .set(this.createMessage())\n        .then(() => {\n          this.setState({ loading: false, message: \"\", errors: [] });\n          typingRef\n            .child(channel.id)\n            .child(user.uid)\n            .remove();\n        })\n        .catch(err => {\n          console.error(err);\n          this.setState({\n            loading: false,\n            errors: this.state.errors.concat(err)\n          });\n        });\n    } else {\n      this.setState({\n        errors: this.state.errors.concat({ message: \"Add a message\" })\n      });\n    }\n  };\n\n  getPath = () => {\n    if (this.props.isPrivateChannel) {\n      return `chat/private/${this.state.channel.id}`;\n    } else {\n      return \"chat/public\";\n    }\n  };\n\n  uploadFile = (file, metadata) => {\n    const pathToUpload = this.state.channel.id;\n    const ref = this.props.getMessagesRef();\n    const filePath = `${this.getPath()}/${uuidv4()}.jpg`;\n\n    this.setState(\n      {\n        uploadState: \"uploading\",\n        uploadTask: this.state.storageRef.child(filePath).put(file, metadata)\n      },\n      () => {\n        this.state.uploadTask.on(\n          \"state_changed\",\n          snap => {\n            const percentUploaded = Math.round(\n              (snap.bytesTransferred / snap.totalBytes) * 100\n            );\n            this.setState({ percentUploaded });\n          },\n          err => {\n            console.error(err);\n            this.setState({\n              errors: this.state.errors.concat(err),\n              uploadState: \"error\",\n              uploadTask: null\n            });\n          },\n          () => {\n            this.state.uploadTask.snapshot.ref\n              .getDownloadURL()\n              .then(downloadUrl => {\n                this.sendFileMessage(downloadUrl, ref, pathToUpload);\n              })\n              .catch(err => {\n                console.error(err);\n                this.setState({\n                  errors: this.state.errors.concat(err),\n                  uploadState: \"error\",\n                  uploadTask: null\n                });\n              });\n          }\n        );\n      }\n    );\n  };\n\n  sendFileMessage = (fileUrl, ref, pathToUpload) => {\n    ref\n      .child(pathToUpload)\n      .push()\n      .set(this.createMessage(fileUrl))\n      .then(() => {\n        this.setState({ uploadState: \"done\" });\n      })\n      .catch(err => {\n        console.error(err);\n        this.setState({\n          errors: this.state.errors.concat(err)\n        });\n      });\n  };\n\n  render() {\n    // prettier-ignore\n    const { errors, message, loading, modal, uploadState, percentUploaded, emojiPicker } = this.state;\n\n    return (\n      <Segment className=\"message__form\">\n        {emojiPicker && (\n          <Picker\n            set=\"apple\"\n            onSelect={this.handleAddEmoji}\n            className=\"emojipicker\"\n            title=\"Pick your emoji\"\n            emoji=\"point_up\"\n          />\n        )}\n        <Input\n          fluid\n          name=\"message\"\n          onChange={this.handleChange}\n          onKeyDown={this.handleKeyDown}\n          value={message}\n          ref={node => (this.messageInputRef = node)}\n          style={{ marginBottom: \"0.7em\" }}\n          label={\n            <Button\n              icon={emojiPicker ? \"close\" : \"add\"}\n              content={emojiPicker ? \"Close\" : null}\n              onClick={this.handleTogglePicker}\n            />\n          }\n          labelPosition=\"left\"\n          className={\n            errors.some(error => error.message.includes(\"message\"))\n              ? \"error\"\n              : \"\"\n          }\n          placeholder=\"Write your message\"\n        />\n        <Button.Group icon widths=\"2\">\n          <Button\n            onClick={this.sendMessage}\n            disabled={loading}\n            color=\"orange\"\n            content=\"Add Reply\"\n            labelPosition=\"left\"\n            icon=\"edit\"\n          />\n          {/* <Button\n            color=\"teal\"\n            disabled={uploadState === \"uploading\"}\n            onClick={this.openModal}\n            content=\"Upload Media\"\n            labelPosition=\"right\"\n            icon=\"cloud upload\"\n          /> */}\n        </Button.Group>\n        <FileModal\n          modal={modal}\n          closeModal={this.closeModal}\n          uploadFile={this.uploadFile}\n        />\n        <ProgressBar\n          uploadState={uploadState}\n          percentUploaded={percentUploaded}\n        />\n      </Segment>\n    );\n  }\n}\n\nexport default MessageForm;\n"]},"metadata":{},"sourceType":"module"}