{"ast":null,"code":"import _toConsumableArray from\"/Users/matthewchang/workspace/github/SEM2020/store-owner-console/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";import _defineProperty from\"/Users/matthewchang/workspace/github/SEM2020/store-owner-console/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/defineProperty\";import _classCallCheck from\"/Users/matthewchang/workspace/github/SEM2020/store-owner-console/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"/Users/matthewchang/workspace/github/SEM2020/store-owner-console/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";import _inherits from\"/Users/matthewchang/workspace/github/SEM2020/store-owner-console/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/inherits\";import _createSuper from\"/Users/matthewchang/workspace/github/SEM2020/store-owner-console/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createSuper\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import{jsx as _jsx}from\"react/jsx-runtime\";import React from\"react\";import{Segment,Comment}from\"semantic-ui-react\";import{connect}from\"react-redux\";import{setUserPosts}from\"../../actions\";import firebase from\"../../firebase\";import MessagesHeader from\"./MessagesHeader\";import MessageForm from\"./MessageForm\";import Message from\"./Message\";import Typing from\"./Typing\";import Skeleton from\"./Skeleton\";var Messages=/*#__PURE__*/function(_React$Component){_inherits(Messages,_React$Component);var _super=_createSuper(Messages);function Messages(){var _this;_classCallCheck(this,Messages);for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}_this=_super.call.apply(_super,[this].concat(args));_this.state={privateChannel:_this.props.isPrivateChannel,privateMessagesRef:firebase.database().ref(\"privateMessages\"),messagesRef:firebase.database().ref(\"messages\"),messages:[],messagesLoading:true,channel:_this.props.currentChannel,isChannelStarred:false,user:_this.props.currentUser,usersRef:firebase.database().ref(\"users\"),numUniqueUsers:\"\",searchTerm:\"\",searchLoading:false,searchResults:[],typingRef:firebase.database().ref(\"typing\"),typingUsers:[],connectedRef:firebase.database().ref(\".info/connected\"),listeners:[]};_this.removeListeners=function(listeners){listeners.forEach(function(listener){listener.ref.child(listener.id).off(listener.event);});};_this.addToListeners=function(id,ref,event){var index=_this.state.listeners.findIndex(function(listener){return listener.id===id&&listener.ref===ref&&listener.event===event;});if(index===-1){var newListener={id:id,ref:ref,event:event};_this.setState({listeners:_this.state.listeners.concat(newListener)});}};_this.scrollToBottom=function(){_this.messagesEnd.scrollIntoView({behavior:\"smooth\"});};_this.addListeners=function(channelId){_this.addMessageListener(channelId);_this.addTypingListeners(channelId);};_this.addTypingListeners=function(channelId){var typingUsers=[];_this.state.typingRef.child(channelId).on(\"child_added\",function(snap){if(snap.key!==_this.state.user.uid){typingUsers=typingUsers.concat({id:snap.key,name:snap.val()});_this.setState({typingUsers:typingUsers});}});_this.addToListeners(channelId,_this.state.typingRef,\"child_added\");_this.state.typingRef.child(channelId).on(\"child_removed\",function(snap){var index=typingUsers.findIndex(function(user){return user.id===snap.key;});if(index!==-1){typingUsers=typingUsers.filter(function(user){return user.id!==snap.key;});_this.setState({typingUsers:typingUsers});}});_this.addToListeners(channelId,_this.state.typingRef,\"child_removed\");_this.state.connectedRef.on(\"value\",function(snap){if(snap.val()===true){_this.state.typingRef.child(channelId).child(_this.state.user.uid).onDisconnect().remove(function(err){if(err!==null){console.error(err);}});}});};_this.addMessageListener=function(channelId){var loadedMessages=[];var ref=_this.getMessagesRef();firebase.database().ref(\"messages/\".concat(_this.state.user.uid,\"/\").concat(channelId)).on(\"child_added\",function(snap){loadedMessages.push(snap.val());_this.setState({messages:loadedMessages,messagesLoading:false});_this.countUniqueUsers(loadedMessages);_this.countUserPosts(loadedMessages);});_this.addToListeners(channelId,ref,\"child_added\");};_this.addUserStarsListener=function(channelId,userId){_this.state.usersRef.child(userId).child(\"starred\").once(\"value\").then(function(data){if(data.val()!==null){var channelIds=Object.keys(data.val());var prevStarred=channelIds.includes(channelId);_this.setState({isChannelStarred:prevStarred});}});};_this.getMessagesRef=function(){var _this$state=_this.state,messagesRef=_this$state.messagesRef,privateMessagesRef=_this$state.privateMessagesRef,privateChannel=_this$state.privateChannel;return privateChannel?privateMessagesRef:messagesRef;};_this.handleStar=function(){_this.setState(function(prevState){return{isChannelStarred:!prevState.isChannelStarred};},function(){return _this.starChannel();});};_this.starChannel=function(){if(_this.state.isChannelStarred){_this.state.usersRef.child(\"\".concat(_this.state.user.uid,\"/starred\")).update(_defineProperty({},_this.state.channel.id,{name:_this.state.channel.name,details:_this.state.channel.details,createdBy:{name:_this.state.channel.createdBy.name,avatar:_this.state.channel.createdBy.avatar}}));}else{_this.state.usersRef.child(\"\".concat(_this.state.user.uid,\"/starred\")).child(_this.state.channel.id).remove(function(err){if(err!==null){console.error(err);}});}};_this.handleSearchChange=function(event){_this.setState({searchTerm:event.target.value,searchLoading:true},function(){return _this.handleSearchMessages();});};_this.handleSearchMessages=function(){var channelMessages=_toConsumableArray(_this.state.messages);var regex=new RegExp(_this.state.searchTerm,\"gi\");var searchResults=channelMessages.reduce(function(acc,message){if(message.message&&message.message.match(regex)||message.senderName.match(regex)){acc.push(message);}return acc;},[]);_this.setState({searchResults:searchResults});setTimeout(function(){return _this.setState({searchLoading:false});},1000);};_this.countUniqueUsers=function(messages){var uniqueUsers=messages.reduce(function(acc,message){if(!acc.includes(message.senderName)){acc.push(message.senderName);}return acc;},[]);var plural=uniqueUsers.length>1||uniqueUsers.length===0;var numUniqueUsers=\"\".concat(uniqueUsers.length,\" user\").concat(plural?\"s\":\"\");_this.setState({numUniqueUsers:numUniqueUsers});};_this.countUserPosts=function(messages){var userPosts=messages.reduce(function(acc,message){if(message.senderName in acc){acc[message.senderName].count+=1;}else{acc[message.senderName]={avatar:message.avatar,count:1};}return acc;},{});_this.props.setUserPosts(userPosts);};_this.displayMessages=function(messages){return messages.length>0&&messages.map(function(message){return/*#__PURE__*/_jsx(Message,{message:message,user:_this.state.user},message.timestamp);});};_this.displayChannelName=function(channel){return channel?\"\".concat(_this.state.privateChannel?\"Customer Name: \":\"Customer Name: \").concat(channel.name):\"\";};_this.displayTypingUsers=function(users){return users.length>0&&users.map(function(user){return/*#__PURE__*/_jsxs(\"div\",{style:{display:\"flex\",alignItems:\"center\",marginBottom:\"0.2em\"},children:[/*#__PURE__*/_jsxs(\"span\",{className:\"user__typing\",children:[user.name,\" is typing\"]}),\" \",/*#__PURE__*/_jsx(Typing,{})]},user.id);});};_this.displayMessageSkeleton=function(loading){return loading?/*#__PURE__*/_jsx(React.Fragment,{children:_toConsumableArray(Array(10)).map(function(_,i){return/*#__PURE__*/_jsx(Skeleton,{},i);})}):null;};return _this;}_createClass(Messages,[{key:\"componentDidMount\",value:function componentDidMount(){var _this$state2=this.state,channel=_this$state2.channel,user=_this$state2.user,listeners=_this$state2.listeners;if(channel&&user){this.removeListeners(listeners);this.addListeners(channel.id);this.addUserStarsListener(channel.id,user.uid);}}},{key:\"componentWillUnmount\",value:function componentWillUnmount(){this.removeListeners(this.state.listeners);this.state.connectedRef.off();}},{key:\"componentDidUpdate\",value:function componentDidUpdate(prevProps,prevState){if(this.messagesEnd){this.scrollToBottom();}}},{key:\"render\",value:function render(){var _this2=this;// prettier-ignore\nvar _this$state3=this.state,messagesRef=_this$state3.messagesRef,messages=_this$state3.messages,channel=_this$state3.channel,user=_this$state3.user,numUniqueUsers=_this$state3.numUniqueUsers,searchTerm=_this$state3.searchTerm,searchResults=_this$state3.searchResults,searchLoading=_this$state3.searchLoading,privateChannel=_this$state3.privateChannel,isChannelStarred=_this$state3.isChannelStarred,typingUsers=_this$state3.typingUsers,messagesLoading=_this$state3.messagesLoading;return/*#__PURE__*/_jsxs(React.Fragment,{children:[/*#__PURE__*/_jsx(MessagesHeader,{channelName:this.displayChannelName(channel),numUniqueUsers:numUniqueUsers,handleSearchChange:this.handleSearchChange,searchLoading:searchLoading,isPrivateChannel:privateChannel,handleStar:this.handleStar,isChannelStarred:isChannelStarred}),/*#__PURE__*/_jsx(Segment,{children:/*#__PURE__*/_jsxs(Comment.Group,{className:\"messages\",children:[this.displayMessageSkeleton(messagesLoading),searchTerm?this.displayMessages(searchResults):this.displayMessages(messages),this.displayTypingUsers(typingUsers),/*#__PURE__*/_jsx(\"div\",{ref:function ref(node){return _this2.messagesEnd=node;}})]})}),/*#__PURE__*/_jsx(MessageForm,{messagesRef:messagesRef,currentChannel:channel,currentUser:user,isPrivateChannel:privateChannel,getMessagesRef:this.getMessagesRef})]});}}]);return Messages;}(React.Component);export default connect(null,{setUserPosts:setUserPosts})(Messages);","map":{"version":3,"sources":["/Users/matthewchang/workspace/github/SEM2020/store-owner-console/src/components/Messages/Messages.js"],"names":["React","Segment","Comment","connect","setUserPosts","firebase","MessagesHeader","MessageForm","Message","Typing","Skeleton","Messages","state","privateChannel","props","isPrivateChannel","privateMessagesRef","database","ref","messagesRef","messages","messagesLoading","channel","currentChannel","isChannelStarred","user","currentUser","usersRef","numUniqueUsers","searchTerm","searchLoading","searchResults","typingRef","typingUsers","connectedRef","listeners","removeListeners","forEach","listener","child","id","off","event","addToListeners","index","findIndex","newListener","setState","concat","scrollToBottom","messagesEnd","scrollIntoView","behavior","addListeners","channelId","addMessageListener","addTypingListeners","on","snap","key","uid","name","val","filter","onDisconnect","remove","err","console","error","loadedMessages","getMessagesRef","push","countUniqueUsers","countUserPosts","addUserStarsListener","userId","once","then","data","channelIds","Object","keys","prevStarred","includes","handleStar","prevState","starChannel","update","details","createdBy","avatar","handleSearchChange","target","value","handleSearchMessages","channelMessages","regex","RegExp","reduce","acc","message","match","senderName","setTimeout","uniqueUsers","plural","length","userPosts","count","displayMessages","map","timestamp","displayChannelName","displayTypingUsers","users","display","alignItems","marginBottom","displayMessageSkeleton","loading","Array","_","i","prevProps","node","Component"],"mappings":"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","sourcesContent":["import React from \"react\";\nimport { Segment, Comment } from \"semantic-ui-react\";\nimport { connect } from \"react-redux\";\nimport { setUserPosts } from \"../../actions\";\nimport firebase from \"../../firebase\";\n\nimport MessagesHeader from \"./MessagesHeader\";\nimport MessageForm from \"./MessageForm\";\nimport Message from \"./Message\";\nimport Typing from \"./Typing\";\nimport Skeleton from \"./Skeleton\";\n\nclass Messages extends React.Component {\n  state = {\n    privateChannel: this.props.isPrivateChannel,\n    privateMessagesRef: firebase.database().ref(\"privateMessages\"),\n    messagesRef: firebase.database().ref(\"messages\"),\n    messages: [],\n    messagesLoading: true,\n    channel: this.props.currentChannel,\n    isChannelStarred: false,\n    user: this.props.currentUser,\n    usersRef: firebase.database().ref(\"users\"),\n    numUniqueUsers: \"\",\n    searchTerm: \"\",\n    searchLoading: false,\n    searchResults: [],\n    typingRef: firebase.database().ref(\"typing\"),\n    typingUsers: [],\n    connectedRef: firebase.database().ref(\".info/connected\"),\n    listeners: []\n  };\n\n  componentDidMount() {\n    const { channel, user, listeners } = this.state;\n\n    if (channel && user) {\n      this.removeListeners(listeners);\n      this.addListeners(channel.id);\n      this.addUserStarsListener(channel.id, user.uid);\n    }\n  }\n\n  componentWillUnmount() {\n    this.removeListeners(this.state.listeners);\n    this.state.connectedRef.off();\n  }\n\n  removeListeners = listeners => {\n    listeners.forEach(listener => {\n      listener.ref.child(listener.id).off(listener.event);\n    });\n  };\n\n  componentDidUpdate(prevProps, prevState) {\n    if (this.messagesEnd) {\n      this.scrollToBottom();\n    }\n  }\n\n  addToListeners = (id, ref, event) => {\n    const index = this.state.listeners.findIndex(listener => {\n      return (\n        listener.id === id && listener.ref === ref && listener.event === event\n      );\n    });\n\n    if (index === -1) {\n      const newListener = { id, ref, event };\n      this.setState({ listeners: this.state.listeners.concat(newListener) });\n    }\n  };\n\n  scrollToBottom = () => {\n    this.messagesEnd.scrollIntoView({ behavior: \"smooth\" });\n  };\n\n  addListeners = channelId => {\n    this.addMessageListener(channelId);\n    this.addTypingListeners(channelId);\n  };\n\n  addTypingListeners = channelId => {\n    let typingUsers = [];\n    this.state.typingRef.child(channelId).on(\"child_added\", snap => {\n      if (snap.key !== this.state.user.uid) {\n        typingUsers = typingUsers.concat({\n          id: snap.key,\n          name: snap.val()\n        });\n        this.setState({ typingUsers });\n      }\n    });\n    this.addToListeners(channelId, this.state.typingRef, \"child_added\");\n\n    this.state.typingRef.child(channelId).on(\"child_removed\", snap => {\n      const index = typingUsers.findIndex(user => user.id === snap.key);\n      if (index !== -1) {\n        typingUsers = typingUsers.filter(user => user.id !== snap.key);\n        this.setState({ typingUsers });\n      }\n    });\n    this.addToListeners(channelId, this.state.typingRef, \"child_removed\");\n\n    this.state.connectedRef.on(\"value\", snap => {\n      if (snap.val() === true) {\n        this.state.typingRef\n          .child(channelId)\n          .child(this.state.user.uid)\n          .onDisconnect()\n          .remove(err => {\n            if (err !== null) {\n              console.error(err);\n            }\n          });\n      }\n    });\n  };\n\n  addMessageListener = channelId => {\n    let loadedMessages = [];\n    const ref = this.getMessagesRef();\n\n    firebase.database().ref(`messages/${this.state.user.uid}/${channelId}`).on(\"child_added\", snap => {\n      loadedMessages.push(snap.val());\n      this.setState({\n        messages: loadedMessages,\n        messagesLoading: false\n      });\n      this.countUniqueUsers(loadedMessages);\n      this.countUserPosts(loadedMessages);\n    });\n    this.addToListeners(channelId, ref, \"child_added\");\n  };\n\n  addUserStarsListener = (channelId, userId) => {\n    this.state.usersRef\n      .child(userId)\n      .child(\"starred\")\n      .once(\"value\")\n      .then(data => {\n        if (data.val() !== null) {\n          const channelIds = Object.keys(data.val());\n          const prevStarred = channelIds.includes(channelId);\n          this.setState({ isChannelStarred: prevStarred });\n        }\n      });\n  };\n\n  getMessagesRef = () => {\n    const { messagesRef, privateMessagesRef, privateChannel } = this.state;\n    return privateChannel ? privateMessagesRef : messagesRef;\n  };\n\n  handleStar = () => {\n    this.setState(\n      prevState => ({\n        isChannelStarred: !prevState.isChannelStarred\n      }),\n      () => this.starChannel()\n    );\n  };\n\n  starChannel = () => {\n    if (this.state.isChannelStarred) {\n      this.state.usersRef.child(`${this.state.user.uid}/starred`).update({\n        [this.state.channel.id]: {\n          name: this.state.channel.name,\n          details: this.state.channel.details,\n          createdBy: {\n            name: this.state.channel.createdBy.name,\n            avatar: this.state.channel.createdBy.avatar\n          }\n        }\n      });\n    } else {\n      this.state.usersRef\n        .child(`${this.state.user.uid}/starred`)\n        .child(this.state.channel.id)\n        .remove(err => {\n          if (err !== null) {\n            console.error(err);\n          }\n        });\n    }\n  };\n\n  handleSearchChange = event => {\n    this.setState(\n      {\n        searchTerm: event.target.value,\n        searchLoading: true\n      },\n      () => this.handleSearchMessages()\n    );\n  };\n\n  handleSearchMessages = () => {\n    const channelMessages = [...this.state.messages];\n    const regex = new RegExp(this.state.searchTerm, \"gi\");\n    const searchResults = channelMessages.reduce((acc, message) => {\n      if (\n        (message.message && message.message.match(regex)) ||\n        message.senderName.match(regex)\n      ) {\n        acc.push(message);\n      }\n      return acc;\n    }, []);\n    this.setState({ searchResults });\n    setTimeout(() => this.setState({ searchLoading: false }), 1000);\n  };\n\n  countUniqueUsers = messages => {\n    const uniqueUsers = messages.reduce((acc, message) => {\n      if (!acc.includes(message.senderName)) {\n        acc.push(message.senderName);\n      }\n      return acc;\n    }, []);\n    const plural = uniqueUsers.length > 1 || uniqueUsers.length === 0;\n    const numUniqueUsers = `${uniqueUsers.length} user${plural ? \"s\" : \"\"}`;\n    this.setState({ numUniqueUsers });\n  };\n\n  countUserPosts = messages => {\n    let userPosts = messages.reduce((acc, message) => {\n      if (message.senderName in acc) {\n        acc[message.senderName].count += 1;\n      } else {\n        acc[message.senderName] = {\n          avatar: message.avatar,\n          count: 1\n        };\n      }\n      return acc;\n    }, {});\n    this.props.setUserPosts(userPosts);\n  };\n\n  displayMessages = messages =>\n    messages.length > 0 &&\n    messages.map(message => (\n      <Message\n        key={message.timestamp}\n        message={message}\n        user={this.state.user}\n      />\n    ));\n\n  displayChannelName = channel => {\n    return channel\n      ? `${this.state.privateChannel ? \"Customer Name: \" : \"Customer Name: \"}${channel.name}`\n      : \"\";\n  };\n\n  displayTypingUsers = users =>\n    users.length > 0 &&\n    users.map(user => (\n      <div\n        style={{ display: \"flex\", alignItems: \"center\", marginBottom: \"0.2em\" }}\n        key={user.id}\n      >\n        <span className=\"user__typing\">{user.name} is typing</span> <Typing />\n      </div>\n    ));\n\n  displayMessageSkeleton = loading =>\n    loading ? (\n      <React.Fragment>\n        {[...Array(10)].map((_, i) => (\n          <Skeleton key={i} />\n        ))}\n      </React.Fragment>\n    ) : null;\n\n  render() {\n    // prettier-ignore\n    const { messagesRef, messages, channel, user, numUniqueUsers, searchTerm, searchResults, searchLoading, privateChannel, isChannelStarred, typingUsers, messagesLoading } = this.state;\n\n    return (\n      <React.Fragment>\n        <MessagesHeader\n          channelName={this.displayChannelName(channel)}\n          numUniqueUsers={numUniqueUsers}\n          handleSearchChange={this.handleSearchChange}\n          searchLoading={searchLoading}\n          isPrivateChannel={privateChannel}\n          handleStar={this.handleStar}\n          isChannelStarred={isChannelStarred}\n        />\n\n        <Segment>\n          <Comment.Group className=\"messages\">\n            {this.displayMessageSkeleton(messagesLoading)}\n            {searchTerm\n              ? this.displayMessages(searchResults)\n              : this.displayMessages(messages)}\n            {this.displayTypingUsers(typingUsers)}\n            <div ref={node => (this.messagesEnd = node)} />\n          </Comment.Group>\n        </Segment>\n\n        <MessageForm\n          messagesRef={messagesRef}\n          currentChannel={channel}\n          currentUser={user}\n          isPrivateChannel={privateChannel}\n          getMessagesRef={this.getMessagesRef}\n        />\n      </React.Fragment>\n    );\n  }\n}\n\nexport default connect(\n  null,\n  { setUserPosts }\n)(Messages);\n"]},"metadata":{},"sourceType":"module"}